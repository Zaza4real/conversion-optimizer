# Deploy backend on Render

Use this to run the Conversion Optimizer API on Render and set **SHOPIFY_APP_URL** to the Render URL.

## 1. Push your code to GitHub or GitLab

Your repo must be in a Git host that Render can connect to (GitHub or GitLab). If it isn’t yet:

```bash
git init
git add .
git commit -m "Initial commit"
# Create a repo on GitHub/GitLab, then:
git remote add origin https://github.com/YOUR_USER/conversion-optimizer.git
git push -u origin main
```

## 2. Connect the repo to Render

1. Go to **[dashboard.render.com](https://dashboard.render.com)** and sign in.
2. Click **New +** → **Blueprint**.
3. Connect your GitHub/GitLab account if needed, then select the **conversion-optimizer** repo.
4. Render will detect `render.yaml` in the repo root. Click **Apply**.

## 3. Set secret environment variables

Render will create the Web Service, Postgres database, and Redis (Key Value). For the **conversion-optimizer-api** service you must set these by hand (they’re marked `sync: false` in the Blueprint):

1. Open the **conversion-optimizer-api** service in the dashboard.
2. Go to **Environment**.
3. Set:
   - **SHOPIFY_API_KEY** — Your app’s Client ID from [Partners](https://partners.shopify.com) → Your app → App setup.
   - **SHOPIFY_API_SECRET** — Your app’s Client secret from the same place.
   - **SHOPIFY_APP_URL** — Leave empty for the first deploy (see step 5).

Save. **ENCRYPTION_KEY** is auto-generated by the Blueprint; you don’t need to set it.

## 4. Deploy

1. Trigger a deploy (e.g. **Manual Deploy** → **Deploy latest commit**).
2. Wait for the build and deploy to finish. The first deploy will run migrations via `preDeployCommand`.

## 5. Set SHOPIFY_APP_URL (required for Shopify)

1. In the Render dashboard, open **conversion-optimizer-api**.
2. At the top you’ll see the service URL, e.g. `https://conversion-optimizer-api-xxxx.onrender.com`. Copy it **without** a trailing slash.
3. Go to **Environment** and add or edit:
   - **SHOPIFY_APP_URL** = `https://conversion-optimizer-api-xxxx.onrender.com` (your actual URL).
4. Save. Render will redeploy so the new value is used.

## 6. Configure Shopify Partners

1. In [Partners](https://partners.shopify.com) → your app → **App setup** (or **Configuration**).
2. Set **App URL** to the same value as **SHOPIFY_APP_URL** (e.g. `https://conversion-optimizer-api-xxxx.onrender.com`).
3. Under **Allowed redirection URL(s)** (or **Redirect URLs**), add:
   - `https://YOUR_RENDER_URL/api/auth/callback`  
   Example: `https://conversion-optimizer-api-xxxx.onrender.com/api/auth/callback`.

Your backend is now the Shopify app URL. OAuth and webhooks will use:

- Install: `https://YOUR_RENDER_URL/api/auth?shop=STORE.myshopify.com`
- Callback: `https://YOUR_RENDER_URL/api/auth/callback`
- Webhooks: `https://YOUR_RENDER_URL/api/webhooks/shopify/TOPIC`

## 7. (Optional) Webhook subscription in Partners

Register webhooks so Shopify can send events to your API:

- In Partners → your app → **App setup** → **Webhooks** (or **Event subscriptions**).
- Add a subscription for each topic; the endpoint URL is:
  - `https://YOUR_RENDER_URL/api/webhooks/shopify/APP_UNINSTALLED`
  - `https://YOUR_RENDER_URL/api/webhooks/shopify/PRODUCTS_CREATE`
  - etc.

Use the same **YOUR_RENDER_URL** as in step 5.

## Troubleshooting

- **Build fails** — Ensure `rootDir: apps/backend` is used so the build runs in the backend app. Check that `npm run build` works locally in `apps/backend`.
- **Migration fails on deploy** — Check **Logs** for the pre-deploy step. Ensure the Postgres database is linked and `DATABASE_URL` is set (Blueprint does this automatically).
- **Redis connection refused** — The Blueprint wires **REDIS_HOST** and **REDIS_PORT** from the Key Value instance. Ensure the Key Value service is in the same region as the web service (default is Oregon).
- **Shopify “Redirect URI mismatch”** — The redirect URL in Partners must be exactly `https://YOUR_RENDER_URL/api/auth/callback` (no trailing slash, same host as App URL).
